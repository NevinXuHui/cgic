---
url: https://blog.csdn.net/u014270566/article/details/107299120
title: Linux ä¸‹ rsyncï¼ˆæœ¬åœ°ã€è¿œç¨‹ï¼‰æ–‡ä»¶åŒæ­¥_ç½—å¾·æ–¯çš„åšå®¢ - CSDN åšå®¢
date: 2023-06-20 13:01:58
tag: 
banner: "undefined"
banner_icon: ðŸ”–
---
## rsync ä»‹ç»ï¼š

sync åŒæ­¥ï¼šåˆ·æ–°æ–‡ä»¶ç³»ç»Ÿç¼“å­˜ï¼Œå¼ºåˆ¶å°†ä¿®æ”¹è¿‡çš„æ•°æ®å—å†™å…¥ç£ç›˜ï¼Œå¹¶ä¸”æ›´æ–°è¶…çº§å¿«ã€‚`ä¸€èˆ¬é‡å¯ç³»ç»Ÿå‰æ‰§è¡Œsyncå‘½ä»¤`  
asyncï¼šå°†æ•°æ®å…ˆç¼“å­˜åœ¨ç¼“å†²åŒºï¼Œå†å‘¨æœŸæ€§ï¼ˆä¸€èˆ¬æ˜¯ 30sï¼‰çš„åŽ»åŒæ­¥åˆ°ç£ç›˜ ã€‚æ€§èƒ½å¥½ï¼Œä½†æ˜¯ä¸èƒ½ä¿è¯æ•°æ®çš„å®‰å…¨æ€§  
rsyncï¼šè¿œç¨‹åŒæ­¥ï¼Œremote synchronous

## rsync ç‰¹ç‚¹ï¼š

1. å¯ä»¥é•œåƒä¿å­˜æ•´ä¸ªç›®å½•æ ‘å’Œæ–‡ä»¶ç³»ç»Ÿ  
2. å¯ä»¥ä¿ç•™åŽŸæœ‰çš„æƒé™ï¼Œownerï¼Œgroupï¼Œæ—¶é—´ï¼Œè½¯ç¡¬é“¾æŽ¥ï¼Œæ–‡ä»¶å±žæ€§ç­‰ä¿¡æ¯  
3. ä¼ è¾“æ•ˆçŽ‡é«˜ï¼Œåªæ¯”è¾ƒå˜åŒ–çš„  
4. æ”¯æŒåŒ¿åä¼ è¾“ï¼Œä¹Ÿå¯ä»¥åšéªŒè¯ï¼ŒåŠ å¼ºå®‰å…¨  
2.4 é€‰é¡¹è¯´æ˜Žå’Œç¤ºä¾‹

## rsync çš„é€‰é¡¹è¯´æ˜Žã€‚

-vï¼šæ˜¾ç¤º rsync è¿‡ç¨‹ä¸­è¯¦ç»†ä¿¡æ¯ã€‚å¯ä»¥ä½¿ç”¨ "-vvvv" èŽ·å–æ›´è¯¦ç»†ä¿¡æ¯ã€‚  
-Pï¼šæ˜¾ç¤ºæ–‡ä»¶ä¼ è¾“çš„è¿›åº¦ä¿¡æ¯ã€‚(å®žé™…ä¸Š "-P"="â€“partial --progress"ï¼Œå…¶ä¸­çš„ "â€“progress" æ‰æ˜¯æ˜¾ç¤ºè¿›åº¦ä¿¡æ¯çš„)ã€‚  
-n --dry-run ï¼šä»…æµ‹è¯•ä¼ è¾“ï¼Œè€Œä¸å®žé™…ä¼ è¾“ã€‚å¸¸å’Œ "-vvvv" é…åˆä½¿ç”¨æ¥æŸ¥çœ‹ rsync æ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚  
-a --archive ï¼šå½’æ¡£æ¨¡å¼ï¼Œè¡¨ç¤ºé€’å½’ä¼ è¾“å¹¶ä¿æŒæ–‡ä»¶å±žæ€§ã€‚ç­‰åŒäºŽ "-rtopgDl"ã€‚  
-r --recursiveï¼šé€’å½’åˆ°ç›®å½•ä¸­åŽ»ã€‚  
-t --timesï¼šä¿æŒ mtime å±žæ€§ã€‚å¼ºçƒˆå»ºè®®ä»»ä½•æ—¶å€™éƒ½åŠ ä¸Š "-t"ï¼Œå¦åˆ™ç›®æ ‡æ–‡ä»¶ mtime ä¼šè®¾ç½®ä¸ºç³»ç»Ÿæ—¶é—´ï¼Œå¯¼è‡´ä¸‹æ¬¡æ›´æ–°  
ï¼šæ£€æŸ¥å‡º mtime ä¸åŒä»Žè€Œå¯¼è‡´å¢žé‡ä¼ è¾“æ— æ•ˆã€‚  
-o --ownerï¼šä¿æŒ owner å±žæ€§ (å±žä¸»)ã€‚  
-g --groupï¼šä¿æŒ group å±žæ€§ (å±žç»„)ã€‚  
-p --permsï¼šä¿æŒ perms å±žæ€§ (æƒé™ï¼Œä¸åŒ…æ‹¬ç‰¹æ®Šæƒé™)ã€‚  
-D ï¼šæ˜¯ "â€“device --specials" é€‰é¡¹çš„ç»„åˆï¼Œå³ä¹Ÿæ‹·è´è®¾å¤‡æ–‡ä»¶å’Œç‰¹æ®Šæ–‡ä»¶ã€‚  
-l --linksï¼šå¦‚æžœæ–‡ä»¶æ˜¯è½¯é“¾æŽ¥æ–‡ä»¶ï¼Œåˆ™æ‹·è´è½¯é“¾æŽ¥æœ¬èº«è€Œéžè½¯é“¾æŽ¥æ‰€æŒ‡å‘çš„å¯¹è±¡ã€‚  
-z ï¼šä¼ è¾“æ—¶è¿›è¡ŒåŽ‹ç¼©æé«˜æ•ˆçŽ‡ã€‚  
-R --relativeï¼šä½¿ç”¨ç›¸å¯¹è·¯å¾„ã€‚æ„å‘³ç€å°†å‘½ä»¤è¡Œä¸­æŒ‡å®šçš„å…¨è·¯å¾„è€Œéžè·¯å¾„æœ€å°¾éƒ¨çš„æ–‡ä»¶åå‘é€ç»™æœåŠ¡ç«¯ï¼ŒåŒ…æ‹¬å®ƒä»¬çš„å±žæ€§ã€‚ç”¨æ³•è§ä¸‹æ–‡ç¤ºä¾‹ã€‚  
â€“size-only ï¼šé»˜è®¤ç®—æ³•æ˜¯æ£€æŸ¥æ–‡ä»¶å¤§å°å’Œ mtime ä¸åŒçš„æ–‡ä»¶ï¼Œä½¿ç”¨æ­¤é€‰é¡¹å°†åªæ£€æŸ¥æ–‡ä»¶å¤§å°ã€‚  
-u --update ï¼šä»…åœ¨æº mtime æ¯”ç›®æ ‡å·²å­˜åœ¨æ–‡ä»¶çš„ mtime æ–°æ—¶æ‰æ‹·è´ã€‚æ³¨æ„ï¼Œè¯¥é€‰é¡¹æ˜¯æŽ¥æ”¶ç«¯åˆ¤æ–­çš„ï¼Œä¸ä¼šå½±å“åˆ é™¤è¡Œä¸ºã€‚  
-d --dirs ï¼šä»¥ä¸é€’å½’çš„æ–¹å¼æ‹·è´ç›®å½•æœ¬èº«ã€‚é»˜è®¤é€’å½’æ—¶ï¼Œå¦‚æžœæºä¸º "dir1/file1"ï¼Œåˆ™ä¸ä¼šæ‹·è´ dir1 ç›®å½•ï¼Œä½¿ç”¨è¯¥é€‰é¡¹å°†æ‹·è´ dir1 ä½†ä¸æ‹·è´ file1ã€‚  
â€“max-size ï¼šé™åˆ¶ rsync ä¼ è¾“çš„æœ€å¤§æ–‡ä»¶å¤§å°ã€‚å¯ä»¥ä½¿ç”¨å•ä½åŽç¼€ï¼Œè¿˜å¯ä»¥æ˜¯ä¸€ä¸ªå°æ•°å€¼ (ä¾‹å¦‚ï¼š"â€“max-size=1.5m")  
â€“min-size ï¼šé™åˆ¶ rsync ä¼ è¾“çš„æœ€å°æ–‡ä»¶å¤§å°ã€‚è¿™å¯ä»¥ç”¨äºŽç¦æ­¢ä¼ è¾“å°æ–‡ä»¶æˆ–é‚£äº›åžƒåœ¾æ–‡ä»¶ã€‚  
â€“exclude ï¼šæŒ‡å®šæŽ’é™¤è§„åˆ™æ¥æŽ’é™¤ä¸éœ€è¦ä¼ è¾“çš„æ–‡ä»¶ã€‚  
â€“delete ï¼šä»¥ SRC ä¸ºä¸»ï¼Œå¯¹ DEST è¿›è¡ŒåŒæ­¥ã€‚å¤šåˆ™åˆ ä¹‹ï¼Œå°‘åˆ™è¡¥ä¹‹ã€‚æ³¨æ„ "â€“delete" æ˜¯åœ¨æŽ¥æ”¶ç«¯æ‰§è¡Œçš„ï¼Œæ‰€ä»¥å®ƒæ˜¯åœ¨  
ï¼šexclude/include è§„åˆ™ç”Ÿæ•ˆä¹‹åŽæ‰æ‰§è¡Œçš„ã€‚  
-b --backup ï¼šå¯¹ç›®æ ‡ä¸Šå·²å­˜åœ¨çš„æ–‡ä»¶åšä¸€ä¸ªå¤‡ä»½ï¼Œå¤‡ä»½çš„æ–‡ä»¶ååŽé»˜è®¤ä½¿ç”¨ "~â€œåšåŽç¼€ã€‚  
â€“backup-dirï¼šæŒ‡å®šå¤‡ä»½æ–‡ä»¶çš„ä¿å­˜è·¯å¾„ã€‚ä¸æŒ‡å®šæ—¶é»˜è®¤å’Œå¾…å¤‡ä»½æ–‡ä»¶ä¿å­˜åœ¨åŒä¸€ç›®å½•ä¸‹ã€‚  
-e ï¼šæŒ‡å®šæ‰€è¦ä½¿ç”¨çš„è¿œç¨‹ shell ç¨‹åºï¼Œé»˜è®¤ä¸º sshã€‚  
â€“port ï¼šè¿žæŽ¥ daemon æ—¶ä½¿ç”¨çš„ç«¯å£å·ï¼Œé»˜è®¤ä¸º 873 ç«¯å£ã€‚  
â€“password-fileï¼šdaemon æ¨¡å¼æ—¶çš„å¯†ç æ–‡ä»¶ï¼Œå¯ä»¥ä»Žä¸­è¯»å–å¯†ç å®žçŽ°éžäº¤äº’å¼ã€‚æ³¨æ„ï¼Œè¿™ä¸æ˜¯è¿œç¨‹ shell è®¤è¯çš„å¯†ç ï¼Œè€Œæ˜¯ rsync æ¨¡å—è®¤è¯çš„å¯†ç ã€‚  
-W --whole-fileï¼šrsync å°†ä¸å†ä½¿ç”¨å¢žé‡ä¼ è¾“ï¼Œè€Œæ˜¯å…¨é‡ä¼ è¾“ã€‚åœ¨ç½‘ç»œå¸¦å®½é«˜äºŽç£ç›˜å¸¦å®½æ—¶ï¼Œè¯¥é€‰é¡¹æ¯”å¢žé‡ä¼ è¾“æ›´é«˜æ•ˆã€‚  
â€“existing ï¼šè¦æ±‚åªæ›´æ–°ç›®æ ‡ç«¯å·²å­˜åœ¨çš„æ–‡ä»¶ï¼Œç›®æ ‡ç«¯è¿˜ä¸å­˜åœ¨çš„æ–‡ä»¶ä¸ä¼ è¾“ã€‚æ³¨æ„ï¼Œä½¿ç”¨ç›¸å¯¹è·¯å¾„æ—¶å¦‚æžœä¸Šå±‚ç›®å½•ä¸å­˜åœ¨ä¹Ÿä¸ä¼šä¼ è¾“ã€‚  
â€“ignore-existingï¼šè¦æ±‚åªæ›´æ–°ç›®æ ‡ç«¯ä¸å­˜åœ¨çš„æ–‡ä»¶ã€‚å’Œâ€â€“existing" ç»“åˆä½¿ç”¨æœ‰ç‰¹æ®ŠåŠŸèƒ½ï¼Œè§ä¸‹æ–‡ç¤ºä¾‹ã€‚  
â€“remove-source-filesï¼šè¦æ±‚åˆ é™¤æºç«¯å·²ç»æˆåŠŸä¼ è¾“çš„æ–‡ä»¶ã€‚

## ç”¨æ³•ï¼š

**1. æœ¬åœ°åŒæ­¥ï¼š**

```
rsync -a æºç›®å½•æˆ–æ–‡ä»¶ ç›®æ ‡ç›®å½•æˆ–æ–‡ä»¶
ä¾‹å¦‚ï¼š
rsync -a /dir1/ /dir2/     #dir1ä¸‹æ‰€æœ‰æ–‡ä»¶åŒæ­¥åˆ°dir2ä¸‹

```

**2. è¿œç¨‹åŒæ­¥ï¼š**

```
rsync -av root@192.168.1.77:/etc/hosts /dir1/     #jå°†192.168.1.77æœåŠ¡å™¨/etc/hostsæ–‡ä»¶æ‹·è´åˆ°æœ¬åœ°/dir1æ–‡ä»¶å¤¹ä¸‹

```

é»˜è®¤æ˜¯éœ€è¦è¾“å…¥å¯†ç æ‰èƒ½åŒæ­¥ï¼Œå› ä¸º rsync åŸºäºŽ ssh æœåŠ¡  
_**æ³¨ï¼šå…å¯†ç™»å½•ï¼Œè¿™åªå¯†é’¥å¯¹**_

**3. å°† rsync ä½œä¸ºæœåŠ¡ï¼Œè¿›è¡ŒåŒæ­¥ (è¿œç¨‹æœåŠ¡å™¨ç«¯è¿›è¡Œå¦‚ä¸‹é…ç½®ï¼‰**

åˆ›å»ºé…ç½®æ–‡ä»¶ï¼š`touch /etc/rsyncd.conf`  
ç¼–è¾‘`/etc/rsyncd.conf`

```
[ava]             #avaä¸ºæ¨¡å—å
log file = /var/log/rsync.log
path=/dir1        #pathä¸ºåŒæ­¥ç›®å½•
uid = root       ä¸è®¾ç½®uidå’Œgidçš„è¯ä¼šæŠ¥é”™ï¼šæœ‰éƒ¨åˆ†æ–‡ä»¶åŒæ­¥å¤±è´¥ï¼Œæç¤ºï¼š`permission denied`      
gid = root

```

å¯åŠ¨ï¼š`rsync --daemon`  
éªŒè¯æ˜¯å¦å¯åŠ¨ï¼š

```
netstat -nltup | grep rsync   #å¯ä»¥çœ‹åˆ°ç«¯å£å·æ˜¯873

```

**`æ‰‹åŠ¨`è¿›è¡Œå¤‡ä»½æ“ä½œï¼šæœ¬åœ°ç«¯æ‰§è¡ŒåŒæ­¥ï¼Œä»Ž 192.168.1.77 åŒæ­¥æ¨¡å—åä¸º`ava`çš„æ–‡ä»¶åˆ°æœ¬åœ°`/tmp/`ç›®å½•ä¸‹ï¼š**

```
rsync -av root@192.168.1.77::ava /tmp/


```

ä¸Šè¿°å‘½ä»¤æ˜¯æ‰‹åŠ¨å®žçŽ°å¤‡ä»½åŠŸèƒ½ï¼Œå¦‚éœ€è‡ªåŠ¨å¤‡ä»½çœ‹ä¸‹ï¼š  
**`è‡ªåŠ¨`å¤‡ä»½**ï¼š  
1. ç¼–å†™è„šæœ¬

```
vim rsync_ava.sh

```

è„šæœ¬å†…å®¹ï¼š

```
#!/bin/bash
rsync -av root@192.168.1.77::ava /tmp/ &>/dev/null

```

ç»™è„šæœ¬æ·»åŠ å¯æ‰§è¡Œæƒé™

```
chmod +x rsync_ava.sh

```

2. æ‰§è¡Œå®šæ—¶ä»»åŠ¡  
ç¼–å†™è®¡åˆ’

```
crontab -e

```

```
03 01 * * * è„šæœ¬è·¯å¾„      #æ¯å¤©1æ—¶3åˆ†æ‰§è¡Œå¤‡ä»½è„šæœ¬

```

æŸ¥è¯¢å®šæ—¶è®¡åˆ’ï¼š

```
crontab -l

```

## æ‹“å±•ï¼š

**å®žæ—¶åŒæ­¥å¤‡ä»½ï¼ˆæœåŠ¡ç«¯æœ‰æ–‡ä»¶æ”¹å˜å°±å¤‡ä»½ï¼‰ï¼šrsync+inotify**  
1. å®‰è£… inotify è½¯ä»¶

```
tar xf inotify-tools-3.13.tar.gz -C /usr/src/
cd /usr/src/inotify-tools-3.13/
./configure
make
make install

```

å®‰è£…åŽä¼šäº§ç”Ÿä¸¤æ¡å‘½ä»¤ï¼š

```
/usr/local/bin/inotifywait        #ç­‰å¾…
/usr/local/bin/inotifywatch     #çœ‹å®ˆ

```

2. ç¼–å†™è„šæœ¬å®žçŽ°åŒæ­¥

```
#!/bin/bash
/usr/local/bin/inotifywait -mrq -e modify,delete,create,attrib,move /dir1
| while read events
			do
				rsync -a --delete /dir1 /dir2/
				echo "'date +%F\ %T'å‡ºçŽ°äº‹ä»¶$events"  >> /var/log/rsync.log
2>&1
		done

```