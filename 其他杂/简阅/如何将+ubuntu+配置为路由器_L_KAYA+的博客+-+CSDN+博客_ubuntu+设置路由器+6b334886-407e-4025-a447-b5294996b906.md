## 1  硬件基础

首先，需要具备的硬件条件是一台具有两个或两个以上网卡的 [Ubuntu](https://so.csdn.net/so/search?q=Ubuntu&spm=1001.2101.3001.7020) 设备，常见的比如一些软路由设备，常规主机一般只有主板上自带的一个网卡，笔记本一般有一个无线网卡以及一个有线网卡。如果当前设备网卡不够，可以购买 USB 网卡或者 PCIe 网卡来进行配置。我使用的是一个系统为 **Ubuntu14.04** 的**六网卡设备**。

## 2  网络环境

在配置交换机前需要明确当前网络环境，最重要的就是需不需要拨号上网。举个例子，假设我们需要配置的 Ubuntu 路由器可以通过连到另一台路由器直接上网，那么就可以省去拨号这一步。我这边的环境需要通过 VPN 拨号上网，因此需要先安装相应的 VPN 软件包以及拨号器。

## 3  Ubuntu 路由器联网

上一步提到如果有其他路由器可以直接上网，那么将 ubuntu 路由器连接到可以上网的路由器即可。若需要 VPN 拨号，以浙大 VPN 为例，它使用 xl2tp 协议，需要先安装两个包。

```Plain Text
sudo apt install xl2tpd
sudo apt install ppp
```

安装完成后, 下载相应的拨号器，可在网上搜索对应 VPN 使用的拨号器，我这边使用了 98 论坛中的一个 [Linux VPN 拨号器](https://www.cc98.org/topic/2323871)。

```Plain Text
sudo vpn-connect -c        //设置账号密码
sudo vpn-connect           //VPN拨号
sudo vpn-connect -d        //断开VPN
```

我连接到了 "eth0" 网卡，设置好静态 IP、子网掩码、网关、DNS 服务器后（下一步会说），通过 VPN 拨号器上网，因此我此时连接外网的网卡（作为 WAN 口）为 "eht0"。（通过 ifconfig 命令可查看当前设备所有网卡，有些名字不一定是 ethx 这种格式的）

## 4  网络配置

刚刚连接的 WAN 口以及内网的 LAN 口需要配置为静态 IP，此处我将 eth5 设置为内网的网卡。

```Plain Text
sudo vim /etc/network/interfaces

```

在该文件中添加

```Plain Text
auto eth0
iface eth0 inet static
address 10.14.113.234
netmask 255.255.255.0
gateway 10.14.113.1
 
auto eth5
iface eth5 inet static
address 192.168.20.1
netmask 255.255.255.0
gateway 192.168.20.1
```

配置好静态 IP、子网掩码、网关地址后，需要设置 DNS 服务器地址（普通网络的 DNS 服务器可从网上搜索，例如 8.8.8.8 等）。网上很多设置 DNS 服务器的方法是在 / etc/resolv.conf 文件中添加 DNS 服务器地址，但是直接修改这个文件虽然当时有用，但是重启后又会被覆盖掉，搜索了一些资料后发现需要修改 / etc/resolvconf/resolv.conf.d/base 这个文件，当时我找半天发现根本没有 resolv.conf.d 这个文件夹，更别说 base 这个文件了，这是因为没有安装 resolvconf 软件包，如果安装完以后还没有这个文件以及文件夹，直接手动创建即可

```Plain Text
sudo apt install resolvconf
sudo vim /etc/resolvconf/resolv.conf.d/base
```

在这个文件中添加 DNS 服务器（可添加多个），不同区域用的 DNS 服务器不同，可以通过 DNS 选优软件选择最佳 DNS 服务器，我这边用的 DNS 服务器是固定的。DNS 服务器的功能就是解析域名，如将 [www.baidu.com](http://www.baidu.com) 解析为 IP 地址，如果后面发现可以通过 ip 地址访问外网却不能通过域名访问外网，说明 DNS 服务器设置有问题。

```Plain Text
nameserver 10.10.0.21

```

保存 base 文件后执行以下语句

```Plain Text
resolvconf -u

```

重启网络使修改生效

```Plain Text
sudo /etc/init.d/networking restart

```

## 5  启用 IP 包转发

```Plain Text
sudo vim /etc/sysctl.conf

```

打开文件后将 net.ipv4.ip_forward=1 前面的注释去掉（vim 打开文件后可输入 / net.ipv4.ip_forward 查找该语句位置）。然后返回 terminal，输入以下命令使修改生效

```Plain Text
sudo sysctl -p

```

## 6  添加路由表

```Plain Text
sudo route add -net 192.168.20.0 netmask 255.255.255.0 dev eth5
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
sudo iptables -t nat -A POSTROUTING -o ppp0 -j MASQUERADE
sudo iptables -A FORWARD -i eth0 -o eth5 -m state --state RELATED,ESTABLISHED -j ACCEPT
sudo iptables -A FORWARD -i eth0 -o eth5 -j ACCEPT
```

第一句话是给 eth5 添加 192.168.20.x 网段的路由表，下面两句话是启用 eth0 和 ppp 的 nat 功能，因为网上很多教程没有 vpn，所以不需要添加 ppp 的 nat 功能，当使用 vpn 连接时就需要添加，没添加的话 eth5 下面带的主机就没法上网。最后两句话是将 eth0 与 eth5 关联起来。

由于系统重启后上面很多指令可能会失效，因此可以在指令最上方加上 VPN 连接指令 sudo vpn-connect，然后写成一个. sh 脚本文件，并将其设置为开机启动即可。

## 7  Ubuntu 路由器下的主机

由于上面我没有在 ubuntu 路由器中添加 DHCP 服务器，所以它没办法给下面的主机分配 IP 地址，需要下面的主机设置静态 IP 地址，设置为 192.168.20.X 即可，另外该主机也需要添加 DNS 服务器，操作都跟第四步一样。配置完重启网络或系统后即可上网。

可能有人会问那 eth5 不是只有一个网口吗，怎么给多个主机同时上网呢？可以使用交换机，将 eth5 与需要上网的主机连接到同交换机上即可供多个主机上网。独立网卡都只能在各自的网段运作吗？不是的，可以通过 bridge 功能将其配置在同一网段，最终达到路由器效果。详情可参考： [如何将 ubuntu 配置为路由器（二）](https://blog.csdn.net/qq_31847339/article/details/102710416)

